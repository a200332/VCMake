<?xml version="1.0" ?>
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html>
<head>
<!-- saved from url=(0017)http://localhost/ -->
<script language="JavaScript" src="../../displayToc.js"></script>
<script language="JavaScript" src="../../tocParas.js"></script>
<script language="JavaScript" src="../../tocTab.js"></script>
<link rel="stylesheet" type="text/css" href="../../scineplex.css">
<title></title>
<link rel="stylesheet" href="../../Active.css" type="text/css" />
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<link rev="made" href="mailto:" />
</head>

<body>



<ul id="index">
  <li><a href="#NAME">NAME</a></li>
  <li><a href="#DESCRIPTION">DESCRIPTION</a></li>
  <li><a href="#SYNOPSIS">SYNOPSIS</a></li>
  <li><a href="#CONSTRUCTION">CONSTRUCTION</a></li>
  <li><a href="#METHODS">METHODS</a>
    <ul>
      <li><a href="#SIMPLE-ACCESSORS">SIMPLE ACCESSORS</a></li>
      <li><a href="#INTERFACE">INTERFACE</a></li>
    </ul>
  </li>
  <li><a href="#SOURCE">SOURCE</a></li>
  <li><a href="#MAINTAINERS">MAINTAINERS</a></li>
  <li><a href="#AUTHORS">AUTHORS</a></li>
  <li><a href="#COPYRIGHT">COPYRIGHT</a></li>
</ul>

<h1 id="NAME">NAME</h1>

<p>Test2::AsyncSubtest - Object representing an async subtest.</p>

<h1 id="DESCRIPTION">DESCRIPTION</h1>

<p>Regular subtests have a limited scope, they start, events are generated, then they close and send an <a href="../../lib/Test2/Event/Subtest.html">Test2::Event::Subtest</a> event. This is a problem if you want the subtest to keep receiving events while other events are also being generated. This class implements subtests that stay open until you decide to close them.</p>

<p>This is mainly useful for tools that start a subtest in one process or thread and then spawn children. In many cases it is nice to let the parent process continue instead of waiting on the children.</p>

<h1 id="SYNOPSIS">SYNOPSIS</h1>

<pre><code>    <span class="keyword">use</span> <span class="variable">Test2::AsyncSubtest</span><span class="operator">;</span>
    
    <span class="keyword">my</span> <span class="variable">$ast</span> <span class="operator">=</span> <span class="variable">Test2::AsyncSubtest</span><span class="operator">-&gt;</span><span class="variable">new</span><span class="operator">(</span><span class="string">name</span> <span class="operator">=&gt;</span> <span class="variable">foo</span><span class="operator">);</span>
    
    <span class="variable">$ast</span><span class="operator">-&gt;</span><span class="variable">run</span><span class="operator">(</span><span class="keyword">sub</span><span class="variable"> </span><span class="operator">{</span>
        <span class="variable">ok</span><span class="operator">(</span><span class="number">1</span><span class="operator">,</span> <span class="string">"Event in parent"</span> <span class="operator">);</span>
    <span class="operator">});</span>
    
    <span class="variable">ok</span><span class="operator">(</span><span class="number">1</span><span class="operator">,</span> <span class="string">"Event outside of subtest"</span><span class="operator">);</span>
    
    <span class="variable">$ast</span><span class="operator">-&gt;</span><span class="variable">run_fork</span><span class="operator">(</span><span class="keyword">sub</span><span class="variable"> </span><span class="operator">{</span>
        <span class="variable">ok</span><span class="operator">(</span><span class="number">1</span><span class="operator">,</span> <span class="string">"Event in child process"</span><span class="operator">);</span>
    <span class="operator">});</span>
    
    <span class="variable">$ast</span><span class="operator">-&gt;</span><span class="variable">run_thread</span><span class="operator">(</span><span class="keyword">sub</span><span class="variable"> </span><span class="operator">{</span>
        <span class="variable">ok</span><span class="operator">(</span><span class="number">1</span><span class="operator">,</span> <span class="string">"Event in child thread"</span><span class="operator">);</span>
    <span class="operator">});</span>
    
    <span class="operator">...</span>
    
    <span class="variable">$ast</span><span class="operator">-&gt;</span><span class="variable">finish</span><span class="operator">;</span>
    
    <span class="variable">done_testing</span><span class="operator">;</span>
</code></pre>

<h1 id="CONSTRUCTION">CONSTRUCTION</h1>

<pre><code>    <span class="keyword">my</span> <span class="variable">$ast</span> <span class="operator">=</span> <span class="variable">Test2::AsyncSubtest</span><span class="operator">-&gt;</span><span class="variable">new</span><span class="operator">(</span> <span class="operator">...</span> <span class="operator">);</span>
</code></pre>

<dl>

<dt id="name-name-required">name =&gt; $name (required)</dt>
<dd>

<p>Name of the subtest. This construction argument is required.</p>

</dd>
<dt id="send_to-hub-optional">send_to =&gt; $hub (optional)</dt>
<dd>

<p>Hub to which the final subtest event should be sent. This must be an instance of <a href="../../lib/Test2/Hub.html">Test2::Hub</a> or a subclass. If none is specified then the current top hub will be used.</p>

</dd>
<dt id="trace-trace-optional">trace =&gt; $trace (optional)</dt>
<dd>

<p>File/Line to which errors should be attributed. This must be an instance of <a href="../../lib/Test2/Util/Trace.html">Test2::Util::Trace</a>. If none is specified then the file/line where the constructor was called will be used.</p>

</dd>
<dt id="hub-hub-optional">hub =&gt; $hub (optional)</dt>
<dd>

<p>Use this to specify a hub the subtest should use. By default a new hub is generated. This must be an instance of <a href="../../lib/Test2/AsyncSubtest/Hub.html">Test2::AsyncSubtest::Hub</a>.</p>

</dd>
</dl>

<h1 id="METHODS">METHODS</h1>

<h2 id="SIMPLE-ACCESSORS">SIMPLE ACCESSORS</h2>

<dl>

<dt id="bool-ast-active">$bool = $ast-&gt;active</dt>
<dd>

<p>True if the subtest is active. The subtest is active if its hub appears in the global hub stack. This is true when <code>$ast-&gt;run(...)</code> us running.</p>

</dd>
<dt id="arrayref-ast-children">$arrayref = $ast-&gt;children</dt>
<dd>

<p>Get an arrayref of child processes/threads. Numerical items are PIDs, blessed items are <a href="../../lib/threads.html">threads</a> instances.</p>

</dd>
<dt id="arrayref-ast-events">$arrayref = $ast-&gt;events</dt>
<dd>

<p>Get an arrayref of events that have been sent to the subtests hub.</p>

</dd>
<dt id="bool-ast-finished">$bool = $ast-&gt;finished</dt>
<dd>

<p>True if <code>finished()</code> has already been called.</p>

</dd>
<dt id="hub-ast-hub">$hub = $ast-&gt;hub</dt>
<dd>

<p>The hub created for the subtest.</p>

</dd>
<dt id="int-ast-id">$int = $ast-&gt;id</dt>
<dd>

<p>Attach/Detach counter. Used internally, not useful to users.</p>

</dd>
<dt id="str-ast-name">$str = $ast-&gt;name</dt>
<dd>

<p>Name of the subtest.</p>

</dd>
<dt id="pid-ast-pid">$pid = $ast-&gt;pid</dt>
<dd>

<p>PID in which the subtest was created.</p>

</dd>
<dt id="tid-ast-tid">$tid = $ast-&gt;tid</dt>
<dd>

<p>Thread ID in which the subtest was created.</p>

</dd>
<dt id="hub-ast-send_to">$hub = $ast-&gt;send_to</dt>
<dd>

<p>Hub to which the final subtest event should be sent.</p>

</dd>
<dt id="arrayref-ast-stack">$arrayref = $ast-&gt;stack</dt>
<dd>

<p>Stack of async subtests at the time this one was created. This is mainly for internal use.</p>

</dd>
<dt id="trace-ast-trace">$trace = $ast-&gt;trace</dt>
<dd>

<p><a href="../../lib/Test2/Util/Trace.html">Test2::Util::Trace</a> instance used for error reporting.</p>

</dd>
</dl>

<h2 id="INTERFACE">INTERFACE</h2>

<dl>

<dt id="ast-attach-id">$ast-&gt;attach($id)</dt>
<dd>

<p>Attach a subtest in a child/process to the original.</p>

<p><b>Note:</b> <code>my $id = $ast-&gt;cleave</code> must have been called in the parent process/thread before the child was started, the id it returns must be used in the call to <code>$ast-&gt;attach($id)</code></p>

</dd>
<dt id="id-ast-cleave">$id = $ast-&gt;cleave</dt>
<dd>

<p>Prepare a slot for a child process/thread to attach. This must be called BEFORE the child process or thread is started. The ID returned is used by <code>attach()</code>.</p>

<p>This must only be called in the original process/thread.</p>

</dd>
<dt id="ctx-ast-context">$ctx = $ast-&gt;context</dt>
<dd>

<p>Get an <a href="../../lib/Test2/API/Context.html">Test2::API::Context</a> instance that can be used to send events to the context in which the hub was created. This is not a canonical context, you should not call <code>$ctx-&gt;release</code> on it.</p>

</dd>
<dt id="ast-detach">$ast-&gt;detach</dt>
<dd>

<p>Detach from the parent in a child process/thread. This should be called just before the child exits.</p>

</dd>
<dt id="ast-finish">$ast-&gt;finish</dt>
<dd>

</dd>
<dt id="ast-finish-options">$ast-&gt;finish(%options)</dt>
<dd>

<p>Finish the subtest, wait on children, and send the final subtest event.</p>

<p>This must only be called in the original process/thread.</p>

<p><b>Note:</b> This calls <code>$ast-&gt;wait</code>.</p>

<p>These are the options:</p>

<dl>

<dt id="collapse-1">collapse =&gt; 1</dt>
<dd>

<p>This intelligently allows a subtest to be empty.</p>

<p>If no events bump the test count then the subtest no final plan will be added. The subtest will not be considered a failure (normally an empty subtest is a failure).</p>

<p>If there are no events at all the subtest will be collapsed into an <a href="../../lib/Test2/Event/Ok.html">Test2::Event::Ok</a> event.</p>

</dd>
<dt id="silent-1">silent =&gt; 1</dt>
<dd>

<p>This will prevent finish from generating a final <a href="../../lib/Test2/Event/Subtest.html">Test2::Event::Subtest</a> event. This effectively ends the subtest without it effecting the parent subtest (or top level test).</p>

</dd>
<dt id="no_plan-1">no_plan =&gt; 1</dt>
<dd>

<p>This will prevent a final plan from being added to the subtest for you when none is directly specified.</p>

</dd>
<dt id="skip-reason">skip =&gt; &quot;reason&quot;</dt>
<dd>

<p>This will issue an <a href="../../lib/Test2/Event/Skip.html">Test2::Event::Skip</a> instead of a subtest. This will throw an exception if any events have been seen, or if state implies events have occurred.</p>

</dd>
</dl>

</dd>
<dt id="out-ast-fork">$out = $ast-&gt;fork</dt>
<dd>

<p>This is a slightly higher level interface to fork. Running it will fork your code in-place just like <code>fork()</code>. It will return a pid in the parent, and an <a href="../../lib/Scope/Guard.html">Scope::Guard</a> instance in the child. An exception will be thrown if fork fails.</p>

<p>It is recommended that you use <code><span class="variable">$ast</span><span class="operator">-&gt;</span><span class="variable">run_fork</span><span class="operator">(</span><span class="keyword">sub</span><span class="variable"> </span><span class="operator">{</span> <span class="operator">...</span> <span class="operator">})</span>
</code> instead.</p>

</dd>
<dt id="bool-ast-pending">$bool = $ast-&gt;pending</dt>
<dd>

<p>True if there are child processes, threads, or subtests that depend on this one.</p>

</dd>
<dt id="bool-ast-ready">$bool = $ast-&gt;ready</dt>
<dd>

<p>This is essentially <code>!$ast-&gt;pending</code>.</p>

</dd>
<dt id="ast-run-sub">$ast-&gt;run(sub { ... })</dt>
<dd>

<p>Run the provided codeblock inside the subtest. This will push the subtest hub onto the stack, run the code, then pop the hub off the stack.</p>

</dd>
<dt id="pid-ast-run_fork-sub">$pid = $ast-&gt;run_fork(sub { ... })</dt>
<dd>

<p>Same as <code>$ast-&gt;run()</code>, except that the codeblock is run in a child process.</p>

<p>You do not need to directly call <code>wait($pid)</code>, that will be done for you when <code>$ast-&gt;wait</code>, or <code>$ast-&gt;finish</code> are called.</p>

</dd>
<dt id="my-thr-ast-run_thread-sub">my $thr = $ast-&gt;run_thread(sub { ... });</dt>
<dd>

<p>Same as <code>$ast-&gt;run()</code>, except that the codeblock is run in a child thread.</p>

<p>You do not need to directly call <code>$thr-&gt;join</code>, that is done for you when <code>$ast-&gt;wait</code>, or <code>$ast-&gt;finish</code> are called.</p>

</dd>
<dt id="passing-ast-start">$passing = $ast-&gt;start</dt>
<dd>

<p>Push the subtest hub onto the stack. Returns the current pass/fail status of the subtest.</p>

</dd>
<dt id="ast-stop">$ast-&gt;stop</dt>
<dd>

<p>Pop the subtest hub off the stack. Returns the current pass/fail status of the subtest.</p>

</dd>
<dt id="ast-wait">$ast-&gt;wait</dt>
<dd>

<p>Wait on all threads/processes that were started using <code>$ast-&gt;fork</code>, <code>$ast-&gt;run_fork</code>, or <code>$ast-&gt;run_thread</code>.</p>

</dd>
</dl>

<h1 id="SOURCE">SOURCE</h1>

<p>The source code repository for Test2-AsyncSubtest can be found at <i>http://github.com/Test-More/Test2-AsyncSubtest/</i>.</p>

<h1 id="MAINTAINERS">MAINTAINERS</h1>

<dl>

<dt id="Chad-Granum-exodist-cpan.org">Chad Granum &lt;exodist@cpan.org&gt;</dt>
<dd>

</dd>
</dl>

<h1 id="AUTHORS">AUTHORS</h1>

<dl>

<dt id="Chad-Granum-exodist-cpan.org1">Chad Granum &lt;exodist@cpan.org&gt;</dt>
<dd>

</dd>
</dl>

<h1 id="COPYRIGHT">COPYRIGHT</h1>

<p>Copyright 2015 Chad Granum &lt;exodist7@gmail.com&gt;.</p>

<p>This program is free software; you can redistribute it and/or modify it under the same terms as Perl itself.</p>

<p>See <i>http://dev.perl.org/licenses/</i></p>


</body>

</html>


